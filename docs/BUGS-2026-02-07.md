# Wallet Bugs — 2026-02-07

## Bug 1: Balance shows incorrect amount after sends

**Symptom:** Wallet had 116.15 DOGE, after sending 1 + 3 + 5 DOGE the balance showed 6.83 instead of ~106.

**Root Cause:** `UtxoManager.getBalance()` skips UTXOs where `locked === true`. When `markSpent()` is called during a send, it sets `locked = true` on the input UTXOs — which correctly excludes them from the balance. However, the **change output** from the transaction is not added to the UTXO set until the next periodic refresh (every 120s). Between `markSpent()` and the next `refresh()`, the balance is understated by the change amount.

Additionally, if the API provider is rate-limited during refresh, the stale cache persists with the locked (spent) UTXOs excluded, making the balance appear drastically low.

**Fix:** After a successful broadcast in `executeSend()`, optimistically add the change output UTXO to the UTXO manager so the balance is immediately correct without waiting for the next refresh cycle.

**File:** `index.ts` → `executeSend()` (after broadcast), `src/utxo/manager.ts` → new `addUtxo()` method

---

## Bug 2: Duplicate receive entries in wallet history

**Symptom:** `/wallet history` showed each incoming transaction twice — once from the original detection and once after `seenTxids` was cleared for testing.

**Root Cause:** The receive monitor uses `seenTxids` (persisted in `receive-state.json`) to track which incoming transactions have already been processed. When `seenTxids` is cleared, the monitor re-detects all existing incoming transactions and calls `onReceive` again, which creates duplicate entries in the audit log.

The audit log (`logReceive`) has no deduplication — it blindly appends every receive event.

**Fix:** Add deduplication to `auditLog.logReceive()` — check if a receive entry with the same `txid` already exists before appending.

**File:** `src/audit.ts` → `logReceive()`

---

## Bug 3: API rate limiting causes stale UTXO data

**Symptom:** Blockchair API returned 430 (rate limit exceeded) during UTXO refresh, causing the wallet to use stale cached data.

**Root Cause:** Heavy polling from confirmation checks + UTXO refreshes + receive monitor all hitting the same free API tier.

**Recommendation:** Use API keys for Blockchair, or implement provider rotation with backoff. This is a known limitation documented in Phase 6 notes.
